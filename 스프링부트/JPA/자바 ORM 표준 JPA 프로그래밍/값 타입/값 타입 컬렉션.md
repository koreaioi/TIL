# 값 타입 컬렉션

값 타입을 컬렉션에 담아서 사용하는 것을 의미한다.   

필드에 컬렉션이 있는 경우 이를 결국, 별도의 테이블로 뽑아서 풀어낸다. (일대다 연관관계로 풀어낸다.)   

![image](https://github.com/user-attachments/assets/841a97b5-83bc-477b-ba23-c36f4f523823)   

## 코드 예시

```java
@Entity
public class Member{
    
    @Id
    @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;
    
    @Column(name = "USERNAME")
    private String username;
    
    @ElementCollection
    @CollectionTable(name = "FAVORITE_FOOD", joinColumn = 
        @JoinColumn(name = "MEMBER_ID") // 현재 테이블의 MEMBER_ID를 외래키로 잡는다.
    )
    private Set<String> favoriteFoods = new HashSet<>();
    
    @ElementCollection
    @CollectionTable(name = "FAVORITE_FOOD", joinColumn =
        @JoinColumn(name = "MEMBER_ID") // 현재 테이블의 MEMBER_ID를 외래키로 잡는다.
    )
    private List<Address> addressHistory = new ArrayList<>();
}
```

@CollectionTable을 생략하면 기본값을 사용해서 매핑한다. 기본값: {엔티티이름}_{컬렉션 속성 이름}   
예를 들어 Member 엔티티의 addressHistory는 Member_addressHistory 테이블과 매핑한다.

## 값 타입 컬렉션 사용

- 값 타입을 하나 이상 저장할 때 사용한다.
- @ElementCollection, @CollectionTable을 사용한다.
- 데이터베이스는 컬렉션을 같은 테이블에 저장할 수 없다.
- 컬렉션을 저장하기 위한 별도의 테이블이 필요하다.

## 값 타입 컬렉션 실제 사용 예시 1

```java
Member member = new Member();

//임베디드 값 타입
member.setHomeAddress(new Address("통영", "몽돌해수욕장", "660-123"));

//기본값 타입 컬렉션
member.getFavoriteFoods().add("짬뽕");
member.getFavoriteFoods().add("짜장");
member.getFavoriteFoods().add("탕수육");

//임베디드 값 타입 컬렉션
member.getAddressHistory().add(new Address("서울", "강남", "123-123"));
member.getAddressHistory().add(new Address("서울", "강북", "000-000"));

em.persist(member);
```

마지막에 member 엔티티만 영속화 했지만 실제 INSERT SQL은 다음과 같이 실행된다.   

- member: INSERT SQL 1번
- member.homeAddress: 컬렉션이 아닌 임베디드 값 타입이므로 회원 테이블을 저장하는 SQL에 포함된다.
- member.favoriteFoods: INSERT SQL 3번
- member.addressHistory: INSERT SQL 2번

결국 **em.persist(member) 한 번 호출로 총 6번의 INSERT SQL을 실행한다.**

## 값 타입 컬렉션 실제 사용 예시 2

```java
Member member = new Member();

//임베디드 값 타입
member.setHomeAddress(new Address("통영", "몽돌해수욕장", "660-123"));

//기본값 타입 컬렉션
member.getFavoriteFoods().add("짬뽕");
member.getFavoriteFoods().add("짜장");
member.getFavoriteFoods().add("탕수육");

//임베디드 값 타입 컬렉션
member.getAddressHistory().add(new Address("서울", "강남", "123-123"));
member.getAddressHistory().add(new Address("서울", "강북", "000-000"));

em.persist(member);

em.flush();
em.clear();

System.out.println("========== START =========")
Member findMember = em.find(Member.class, ID값);
```


### 실행 결과

![image](https://github.com/user-attachments/assets/cfbfbb48-46dd-426e-8adc-b409aa240cd1)

실행되는 SQL을 보면 Member만 조회해온다.   
즉, 컬렉션들은 모두 지연 로딩이라는 뜻이다.   
단, Address는 Member에 소속된 임베디드 타입이므로 바로 불러온다.   

따라서

```java
List<Address> addressHistory = findMember.getADdressHistory();
```

위와 같이 실제 addressHistory를 사용하는 시점에 가져온다.   

